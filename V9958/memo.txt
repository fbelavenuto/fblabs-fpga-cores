○ 2006/9/24 ドラクエ２オープニング
盾がスクロールしてくるオープニングで、盾が降りきるとスプライトが消えて
しまい、DRAGON QUESTの文字が消える

[盾（縦）スクロール中のVDPレジスタ]
R#05 6F  
R#06 27
R#0B 02
  SpColorTblBase Addr => 26f & 0b11111000 = 0x13400
  SpAttrTblBase Addr  => 26f & 0b11111100 = 0x13600
  SpPtnGene           => 27  = 0x13800

[盾（縦）スクロール後のVDPレジスタ]
R#05 EF
R#06 0F
R#0B 00
  SpColorTblBase Addr => 0ef& 0b11111000  =  0x7400
  SpAttrTblBase Addr  => 0ef& 0b11111100  =  0x7600
  SpPtnGene           => 0f =  0x7800

というように、スプライトテーブルの位置が変わっている。
スプライトテーブルの位置が変わる時に、VDPコマンドでYMMMが
実行されている。実行内容は以下の通り。

(SX 0x066) 
SY 0x260 => 0x13000
DX 0x0
DY 0x0e0 => 0x7000
(NX 0x0e0)
NY 0x20  => 0x1000
DIX 0
DIY 0

ということで、このYMMMによってスプライトテーブルが移動されて
いるはずなのだが、、、。

そこで、ドラクエ2のオープニング実行中にリセットし、BASICから
スプライトテーブルベースアドレスを「スクロール中」の状態に
セットしてみた。すると、なんとなくスプライトが表示された。
（上部が欠けてしまっているようにみえるのは謎)

次に、上記YMMM VDPコマンドをBASICから実行してみたところ、
スプライトテーブルがコピーされた。ベースアドレスを
「スクロール後」にセットしてみたら、同じようなスプライトが
表示された。だったら動いてもよさそうだが、、なぜ？

--
blueMSXというエミュレータでも同様の化け方をする。(v2.6)
blueMSXのデバッグ機能を使ったところ、メモリアドレス0x596dの
場所で、VDPのR#46に0xe0を書き込んでYMMMを実行しているのが
わかった。

VDPコマンド発行前後でVRAMの内容をダンプしてみると、なぜか
0x7000〜0x75ffまでの0x600分しかデータがコピーされていない。

このとき、VDPコマンドが実行完了するのを待っているループの
先でブレークポイントを設定し、完了直後で停止するようにした。
にもかかわらず、Dragon Quest IIの"II"の文字が1ライン下がる
のが見えた。
どうやらIIの文字を1ライン下げる処理を割り込みを使って行って
いるらしく、YMMM実行完了前にHMMMなどの他のVDPコマンドが
実行されてしまっているのかもしれない。

すると、この問題は割り込みタイミングが実機と違うのが原因か、
あるいは、他のVDPコマンドを実行している時に別のコマンドを
発行したときの挙動の違いから来ているのではないかと思う。

--
2006/10/05
スプライトが消える原因は分かった。上記推測は間違い。
割り込み処理ルーチンのなかで0xc288->0xc27c->0xc4ee番地への
一連の呼び出しが行われていて、この処理でメインメモリの0xde00
からVRAMの0x7600番地へスプライトアトリビュートテーブルの
転送が行われている。

そのため、YMMMが完了してスプライトテーブルのコピーが終わった
直後にこのルーチンがよばれ、VRAMの0x7600番地が上書きされて
しまっている。

実機ではなぜこのルーチンが呼ばれないのか？

このルーチンが呼ばれる条件を少し追ってみたところ、ステータス
レジスタ#0のbit6、つまり、第５スプライト判定ビットが1に
なっているとこのルーチンが呼ばれるらしい。

つまり、S#0 bit6の挙動が実VDPとは異なる事がこの問題の
原因のようである。

暫定処置だが、第５スプライト判定ビットを常に'0'になるように
したところスプライトが消えなくなった。

おそらくゲーム中ではこのフラグを見てスプライトを交互に
表示する処理を書いているのだろう。なので、常に'0'にするのは
まずいのだが、とりあえずこのままにしておく。
